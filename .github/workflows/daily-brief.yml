name: daily-brief

# Daily Brief + Approvals Queue Generator ‚Äî Antigravity Board Member Loop
# This workflow generates daily operational artifacts for Founder review.
# Runs daily at 09:00 UTC and on manual dispatch.

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not create PR)'
        required: false
        type: boolean
        default: false
  schedule:
    # Run daily at 09:00 UTC
    - cron: '0 9 * * *'

jobs:
  generate_daily_brief:
    name: Generate Daily Brief + Approvals Queue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate Daily Brief
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          GITHUB_PROJECT_NUMBER: '2'  # SDLC Project number
        run: |
          echo "ü§ñ Generating Daily Brief + Approvals Queue"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Dry run: ${{ github.event.inputs.dry_run || false }}"
          echo ""

          # Generate artifacts
          output=$(python scripts/generate_daily_brief.py)
          brief_path=$(echo "$output" | grep "brief_file=" | cut -d'=' -f2)
          approvals_path=$(echo "$output" | grep "approvals_file=" | cut -d'=' -f2)

          echo "Brief path: $brief_path"
          echo "Approvals path: $approvals_path"

          # Set outputs
          echo "brief_path=$brief_path" >> $GITHUB_OUTPUT
          echo "approvals_path=$approvals_path" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-brief-artifacts
          path: |
            ${{ steps.generate.outputs.brief_path }}
            ${{ steps.generate.outputs.approvals_path }}
          retention-days: 30

      - name: Write brief to workflow summary
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "## Daily Brief Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ steps.generate.outputs.brief_path }}" ]; then
            echo "### Brief" >> $GITHUB_STEP_SUMMARY
            head -50 "${{ steps.generate.outputs.brief_path }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "${{ steps.generate.outputs.approvals_path }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Approvals Queue" >> $GITHUB_STEP_SUMMARY
            head -50 "${{ steps.generate.outputs.approvals_path }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full artifacts available in the workflow run **Artifacts** tab." >> $GITHUB_STEP_SUMMARY

      - name: Report Summary
        if: always()
        run: |
          echo "## Daily Brief Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Brief path: \`${{ steps.generate.outputs.brief_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Approvals path: \`${{ steps.generate.outputs.approvals_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: ${{ github.event.inputs.dry_run || false }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts available in workflow run artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Failure notification
        if: failure()
        run: |
          echo "‚ùå Daily brief generation failed"
          echo "Check workflow logs for errors"
          exit 1
