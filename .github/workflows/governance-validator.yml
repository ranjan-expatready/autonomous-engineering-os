name: Governance Validator ‚Äî Machine Board of Directors

# Pull Request Governance Enforcement
# This workflow enforces automated governance on all pull requests.
# PRs must pass all validation checks before merge is allowed.

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]

# Allow manual trigger for testing
workflow_dispatch:

jobs:
  governance-validator:
    name: Machine Board Validation
    runs-on: ubuntu-latest

    # IMPORTANT: This job must run on the PR head commit
    # to access PR description and changed files
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run Governance Validator
        id: govern
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_DESCRIPTION: ${{ github.event.pull_request.body }}
          GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "ü§ñ Running Machine Board of Directors Governance Validator"
          echo "PR Number: $PR_NUMBER"
          echo "Base Branch: $GITHUB_BASE_REF"
          echo ""
          
          python scripts/governance_validator.py

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: governance-validator-results
          path: .governance_validator_results.json
          retention-days: 30

      - name: Comment results on PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const resultsPath = '.governance_validator_results.json';
            
            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              
              let comment = '## ü§ñ Machine Board of Directors - Validation Results\n\n';
              
              const passed = results.results.every(r => r.passed);
              const status = passed ? '‚úÖ PASSED' : '‚ùå FAILED';
              
              comment += `**Overall Status: ${status}**\n\n`;
              comment += '### Validation Checks\n\n';
              
              results.results.forEach(r => {
                const icon = r.passed ? '‚úÖ' : '‚ùå';
                comment += `${icon} **${r.name}**\n`;
                if (r.message) {
                  comment += `   ${r.message}\n`;
                }
                comment += '\n';
              });
              
              // Add guidance for failures
              if (!passed) {
                comment += '### Required Actions\n\n';
                comment += 'To fix validation failures:\n\n';
                comment += '1. **Missing Artifacts**: Add PLAN and VERIFICATION sections to PR description\n';
                comment += '2. **STATE Files**: Update STATE/STATUS_LEDGER.md and STATE/LAST_KNOWN_STATE.md\n';
                comment += '3. **Risk Tier**: For T1/T2, include rollback plan and verification proof\n';
                comment += '4. **Secrets**: Remove or rotate any exposed credentials\n\n';
                comment += 'See GOVERNANCE/GUARDRAILS.md for detailed requirements.\n';
              }
              
              // Post comment
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Fail if validation failed
        if: steps.govern.outcome == 'failure'
        run: |
          echo "‚ùå Governance validation failed"
          echo "Please fix the validation errors and push a new commit."
          exit 1

  # Summary job for better visibility
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: governance-validator
    if: always()
    
    steps:
      - name: Download results
        uses: actions/download-artifact@v3
        with:
          name: governance-validator-results
      
      - name: Display summary
        run: |
          if [ -f .governance_validator_results.json ]; then
            echo "## Governance Validation Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat .governance_validator_results.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set overall status
        if: needs.governance-validator.result == 'success'
        run: |
          echo "‚úÖ All governance validations passed"
          
      - name: Set failure status
        if: needs.governance-validator.result == 'failure'
        run: |
          echo "‚ùå Governance validation failed"
          echo "Please review the PR comments for detailed guidance"
          exit 1
